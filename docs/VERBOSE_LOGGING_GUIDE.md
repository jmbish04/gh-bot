#!/bin/bash

echo "Webhook Verbose Logging Test"
echo "============================="
echo ""
echo "The verbose logging has been added to track down the 'Body has already been used' error."
echo ""
echo "Changes made:"
echo "1. Added comprehensive logging to /src/index.ts webhook route"
echo "2. Added detailed logging to /src/routes/webhook.ts handleWebhook function"
echo ""
echo "Key logging points:"
echo "- [MAIN] prefix: Main webhook handler in index.ts"
echo "- [WEBHOOK] prefix: Webhook processor in routes/webhook.ts"
echo ""
echo "Expected log flow for successful request:"
echo "1. [MAIN] Webhook request received"
echo "2. [MAIN] Reading request headers..."
echo "3. [MAIN] Headers extracted"
echo "4. [MAIN] Reading request body..."
echo "5. [MAIN] Body read successfully"
echo "6. [MAIN] Calling handleWebhook..."
echo "7. [WEBHOOK] Starting webhook processing"
echo "8. [WEBHOOK] Starting signature verification"
echo "9. [WEBHOOK] Signature verification result"
echo "10. [WEBHOOK] Parsing JSON payload..."
echo "11. [WEBHOOK] JSON parsed successfully"
echo "12. [WEBHOOK] Processing event type"
echo ""
echo "If the 'Body has already been used' error occurs, the logs will show:"
echo "- Where exactly the error happens"
echo "- Whether it's in the main handler or webhook processor"
echo "- Which step in the process triggers the error"
echo ""
echo "To deploy these changes:"
echo "1. Run: cd /Volumes/Projects/workers/gh-bot"
echo "2. Run: npx wrangler deploy"
echo "3. Send a test webhook to trigger the logs"
echo "4. Check Cloudflare Worker logs in the dashboard"
echo ""
echo "Test webhook command:"
echo 'curl -X POST https://gh-bot.hacolby.workers.dev/github/webhook \'
echo '  -H "Content-Type: application/json" \'
echo '  -H "X-GitHub-Event: ping" \'
echo '  -H "X-GitHub-Delivery: test-$(date +%s)" \'
echo '  -H "X-Hub-Signature-256: sha256=invalid" \'
echo '  -d '"'"'{"zen": "Test webhook"}'"'"
echo ""
echo "The verbose logs will help identify:"
echo "- If the error is in request.text() call"
echo "- If the error is in response.text() call"
echo "- If there are multiple body consumption attempts"
echo "- The exact line/function where the error occurs"
