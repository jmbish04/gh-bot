<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gh-bot Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css"
      integrity="sha512-ls4PRpkTcVxpKa+wVU+p+PM7HLszVd00ENIm0rtvpD4K1JkPFAtFzI43fJqlZLKF+Fku0X7m0h9a4i6Yeg+ANw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="/nav.js" defer></script>
    <script src="/server.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js" defer></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <nav id="site-nav"></nav>
    <main class="max-w-6xl mx-auto px-4 py-10 space-y-10">
      <section>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-semibold text-white">Recent Activity</h2>
            <p class="text-sm text-slate-400">Latest GitHub webhook deliveries processed by gh-bot.</p>
          </div>
          <div id="activity-summary" class="text-sm text-slate-400"></div>
        </div>
        <div class="mt-6 overflow-hidden rounded-xl border border-slate-800 bg-slate-900/60 shadow-xl shadow-slate-950/40">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800">
              <thead class="bg-slate-900/80">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-widest text-slate-400">Delivery</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-widest text-slate-400">Event</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-widest text-slate-400">Repo</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-widest text-slate-400">Author</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-widest text-slate-400">Status</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-widest text-slate-400">Received</th>
                </tr>
              </thead>
              <tbody id="recent-activity-table" class="divide-y divide-slate-800/60">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-sm text-slate-400">Loading recent events…</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-semibold text-white">Repositories</h2>
            <p class="text-sm text-slate-400">Top repositories seen by the bot with failure counts.</p>
          </div>
        </div>
        <div id="repositories-grid" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
          <div class="col-span-full flex justify-center py-10 text-sm text-slate-400">Loading repositories…</div>
        </div>
      </section>

      <section>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-semibold text-white">Event Types</h2>
            <p class="text-sm text-slate-400">Breakdown by webhook type with error visibility.</p>
          </div>
        </div>
        <div id="event-types-grid" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
          <div class="col-span-full flex justify-center py-10 text-sm text-slate-400">Loading event types…</div>
        </div>
      </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const {
          getRecentActivity,
          getRepositories,
          getEventTypes,
          formatTimestamp,
        } = window.dashboardApi || {};

        if (!getRecentActivity) {
          return;
        }

        const [recent, repositories, eventTypes] = await Promise.allSettled([
          getRecentActivity(),
          getRepositories(),
          getEventTypes(),
        ]);

        const recentEvents = recent.status === 'fulfilled' ? recent.value : [];
        const repoStats = repositories.status === 'fulfilled' ? repositories.value : [];
        const typeStats = eventTypes.status === 'fulfilled' ? eventTypes.value : [];

        const activityTable = document.getElementById('recent-activity-table');
        const activitySummary = document.getElementById('activity-summary');
        if (activityTable) {
          activityTable.innerHTML = '';
          if (recentEvents.length === 0) {
            activityTable.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-sm text-slate-500">No webhook deliveries recorded yet.</td></tr>';
          } else {
            recentEvents.forEach((event) => {
              const row = document.createElement('tr');
              row.className = 'hover:bg-slate-900/80 transition-colors';
              const statusBadge = event.response_status === 'error'
                ? '<span class="inline-flex items-center rounded-full bg-rose-500/20 px-2 py-1 text-xs font-semibold text-rose-300">error</span>'
                : '<span class="inline-flex items-center rounded-full bg-emerald-500/20 px-2 py-1 text-xs font-semibold text-emerald-300">success</span>';

              row.innerHTML = `
                <td class="px-4 py-3 font-mono text-xs text-slate-400">
                  <a href="/detail.html?deliveryId=${encodeURIComponent(event.delivery_id)}" class="hover:text-sky-300">
                    ${event.delivery_id.slice(0, 8)}…
                  </a>
                </td>
                <td class="px-4 py-3 text-sm text-white">
                  <div class="font-medium capitalize">${event.event_type.replace(/_/g, ' ')}</div>
                  <div class="text-xs text-slate-500">${event.action || '—'}</div>
                </td>
                <td class="px-4 py-3 text-sm">
                  <a href="/repo.html?name=${encodeURIComponent(event.repo_full_name || '')}" class="text-sky-300 hover:text-sky-200">
                    ${event.repo_full_name || '—'}
                  </a>
                </td>
                <td class="px-4 py-3 text-sm text-slate-300">${event.author_login || '—'}</td>
                <td class="px-4 py-3 text-sm">${statusBadge}</td>
                <td class="px-4 py-3 text-sm text-slate-300">${formatTimestamp(event.received_at)}</td>
              `;
              activityTable.appendChild(row);
            });
            if (activitySummary) {
              activitySummary.textContent = `${recentEvents.length} deliveries in the last snapshot.`;
            }
          }
        }

        const repoGrid = document.getElementById('repositories-grid');
        if (repoGrid) {
          repoGrid.innerHTML = '';
          if (repoStats.length === 0) {
            repoGrid.innerHTML = '<div class="col-span-full flex justify-center py-10 text-sm text-slate-500">No repositories have been processed yet.</div>';
          } else {
            repoStats.forEach((repo) => {
              const card = document.createElement('a');
              card.href = `/repo.html?name=${encodeURIComponent(repo.repo)}`;
              card.className = 'group rounded-xl border border-slate-800 bg-slate-900/50 p-5 shadow-lg shadow-slate-950/30 transition-all hover:border-sky-500/60 hover:shadow-sky-900/40';
              card.innerHTML = `
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white group-hover:text-sky-300">${repo.repo}</h3>
                  <span class="rounded-full bg-slate-800 px-3 py-1 text-xs font-semibold text-slate-300">${repo.event_count} events</span>
                </div>
                <p class="mt-3 text-sm text-slate-400">${repo.error_count} failures logged.</p>
              `;
              repoGrid.appendChild(card);
            });
          }
        }

        const typeGrid = document.getElementById('event-types-grid');
        if (typeGrid) {
          typeGrid.innerHTML = '';
          if (typeStats.length === 0) {
            typeGrid.innerHTML = '<div class="col-span-full flex justify-center py-10 text-sm text-slate-500">No event types recorded.</div>';
          } else {
            typeStats.forEach((entry) => {
              const card = document.createElement('a');
              card.href = `/event.html?type=${encodeURIComponent(entry.event)}`;
              card.className = 'group rounded-xl border border-slate-800 bg-slate-900/50 p-5 shadow-lg shadow-slate-950/30 transition-all hover:border-sky-500/60 hover:shadow-sky-900/40';
              card.innerHTML = `
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-white group-hover:text-sky-300">${entry.event}</h3>
                  <span class="rounded-full bg-slate-800 px-3 py-1 text-xs font-semibold text-slate-300">${entry.count} events</span>
                </div>
                <p class="mt-3 text-sm text-slate-400">${entry.error_count} failures.</p>
              `;
              typeGrid.appendChild(card);
            });
          }
        }
      });
    </script>
  </body>
</html>
